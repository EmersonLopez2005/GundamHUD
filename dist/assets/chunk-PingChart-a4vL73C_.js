import{r as l,j as t,P as q,c as N,i as G,u as X,s as Y,m as J,w as D,B as H}from"./entry-index-DK0wTc_i.js";import{C as E,c as F,a as Q}from"./chunk-card-Bf39RBRU.js";import{o as U,w as Z,x as S,y as ee,R as te,p as se,r as ne,X as ae,Y as ie,T as re,t as oe,v as le,z as ce,q as de,B as ue}from"./chunk-chartHelper-BdgZw1x1.js";import{T}from"./chunk-tips-CZ7npuTU.js";import"./chunk-react-vendor-c5ypKtDW.js";import"./chunk-progress-circle-DvZ4GioP.js";var me="Label",I=l.forwardRef((g,d)=>t.jsx(q.label,{...g,ref:d,onMouseDown:u=>{u.target.closest("button, input, select, textarea")||(g.onMouseDown?.(u),!u.defaultPrevented&&u.detail>1&&u.preventDefault())}}));I.displayName=me;/**
 * @license lucide-react v0.537.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=[["path",{d:"M17 12H3",key:"8awo09"}],["path",{d:"m11 18 6-6-6-6",key:"8c2y43"}],["path",{d:"M21 5v14",key:"nzette"}]],xe=N("arrow-right-to-line",he);/**
 * @license lucide-react v0.537.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],fe=N("eye-off",ge);/**
 * @license lucide-react v0.537.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],ke=N("eye",pe);/**
 * @license lucide-react v0.537.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],ye=N("refresh-cw",je),ve=(g,d)=>{const{getPingHistory:u}=G(),[f,b]=l.useState(null),[M,n]=l.useState(!0),[p,k]=l.useState(null);return l.useEffect(()=>{if(!g?.uuid){b(null),n(!1);return}n(!0),k(null),(async()=>{try{const h=await u(g.uuid,d);b(h)}catch(h){k(h.message||"Failed to fetch history data")}finally{n(!1)}})()},[g?.uuid,d,u]),{loading:M,error:p,pingHistory:f}},Te=l.memo(({node:g,hours:d})=>{const{enableConnectBreaks:u,pingChartMaxPoints:f}=X(),{loading:b,error:M,pingHistory:n}=ve(g,d),[p,k]=l.useState([]),[j,h]=l.useState(null),[z,y]=l.useState({}),[w,R]=l.useState(!1),[v,$]=l.useState(u),[L,P]=l.useState(!1),A=Y();l.useEffect(()=>{if(n?.tasks){const e=n.tasks.map(s=>s.id);k(s=>{const a=e.filter(i=>s.length===0||s.includes(i));return a.length>0?a:e})}},[n?.tasks]),l.useEffect(()=>{L&&(h(null),y({}),P(!1))},[L]);const B={top:8,right:16,bottom:8,left:16},r=l.useMemo(()=>{if(!n||!n.records||!n.tasks)return[];const e={},s=[];for(const i of n.records){const o=new Date(i.time).getTime();let c=null;for(const C of s)if(Math.abs(C-o)<=5e3){c=C;break}const m=c!==null?c:o;e[m]||(e[m]={time:m},c===null&&s.push(m)),e[m][i.task_id]=i.value===-1?null:i.value}let a=Object.values(e).sort((i,o)=>i.time-o.time);if(d!==0){let o=n.tasks[0]?.interval||60;const c=o*1.2,m=d,C=d*60*60;m>720?o=3600:m>168?o=900:m>24&&(o=300),a=U(a,o,C,c),a=a.map(_=>({..._,time:new Date(_.time).getTime()}))}if(a.length>f&&f>0){console.log(`数据量过大 (${a.length}), 降采样至 ${f} 个点。`);const i=Math.ceil(a.length/f),o=[];for(let c=0;c<a.length;c+=i)o.push(a[c]);a=o}if(w&&n.tasks.length>0){const i=n.tasks.map(o=>String(o.id));a=Z(a,i)}return a},[n,d,f,w]),K=e=>{k(s=>s.includes(e)?s.filter(a=>a!==e):[...s,e])},V=()=>{n?.tasks&&(p.length===n.tasks.length?k([]):k(n.tasks.map(e=>e.id)))},x=l.useMemo(()=>n?.tasks?[...n.tasks].sort((e,s)=>e.id-s.id):[],[n?.tasks]),W=l.useMemo(()=>{if(!v||!r||r.length<2)return[];const e=[];for(const s of x){if(!p.includes(s.id))continue;const a=String(s.id);for(let i=1;i<r.length;i++){const o=r[i-1],c=r[i];(c[a]===null||c[a]===void 0)&&o[a]!==null&&o[a]!==void 0&&e.push({x:c.time,color:S(s.name,x)})}}return e},[r,x,p,v]),O=l.useMemo(()=>!n?.records||!x.length?[]:x.map(e=>{const{loss:s,latestValue:a,latestTime:i}=ee(n.records,e.id,j);return{...e,value:a,time:i,loss:s,color:S(e.name,x)}}),[n?.records,x,j]);return t.jsxs("div",{className:"relative space-y-4",children:[b&&t.jsx("div",{className:"absolute inset-0 flex items-center justify-center purcarte-blur rounded-lg z-10",children:t.jsx(J,{text:"正在加载图表数据..."})}),M&&t.jsx("div",{className:"absolute inset-0 flex items-center justify-center purcarte-blur rounded-lg z-10",children:t.jsx("p",{className:"text-red-500",children:M})}),n?.tasks&&n.tasks.length>0&&t.jsxs(E,{className:"relative",children:[t.jsx("div",{className:"absolute top-2 right-2",children:t.jsx(T,{children:t.jsx("span",{dangerouslySetInnerHTML:{__html:"<p>丢包率计算算法并不准确，谨慎参考</p>"}})})}),t.jsx(F,{className:"p-2",children:t.jsx("div",{className:"flex flex-wrap gap-2 items-center justify-center",children:O.map(e=>{const s=p.includes(e.id);return t.jsxs("div",{className:`h-auto px-3 py-1.5 flex flex-col leading-snug text-center cursor-pointer rounded-md transition-all outline-2 outline ${s?"":"outline-transparent"}`,onClick:()=>K(e.id),style:{outlineColor:s?e.color:void 0,boxShadow:s?`0 0 8px ${e.color}`:void 0},children:[t.jsx("div",{className:"font-semibold",children:e.name}),t.jsx("div",{className:"flex text-xs font-normal",children:t.jsx("span",{children:e.value!==null?`${e.value.toFixed(1)} ms | ${e.loss.toFixed(1)}%`:"N/A"})})]},e.id)})})})]}),t.jsxs(E,{children:[t.jsx(Q,{children:t.jsxs("div",{className:"flex justify-between items-center flex-wrap",children:[t.jsxs("div",{className:"flex gap-4 flex-wrap",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(D,{id:"peak-shaving",checked:w,onCheckedChange:R}),t.jsx(I,{htmlFor:"peak-shaving",children:"平滑"}),t.jsx(T,{children:t.jsx("span",{dangerouslySetInnerHTML:{__html:'<h2 class="text-lg font-bold">关于数据平滑的提示</h2><p>当您开启平滑后，您在统计图中看到的曲线经过<strong>指数加权移动平均 (EWMA)</strong> 算法处理，这是一种常用的数据平滑技术。</p></br><p>需要注意的是，经过EWMA算法平滑后的曲线所展示的数值，<strong>并非原始的、真实的测量数据</strong>。它们是根据EWMA算法计算得出的一个<strong>平滑趋势线</strong>，旨在减少数据波动，使数据模式和趋势更容易被识别。</p></br><p>因此，您看到的数值更像是<strong>视觉上的呈现</strong>，帮助您更好地理解数据的整体走向和长期趋势，而不是每一个时间点的精确真实值。如果您需要查看具体、原始的数据点，请参考未经平滑处理的数据视图。</p>'}})})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(D,{id:"connect-breaks",checked:v,onCheckedChange:$}),t.jsx(I,{htmlFor:"connect-breaks",children:"连接断点"}),t.jsx(T,{children:t.jsx("span",{dangerouslySetInnerHTML:{__html:'<h2 class="text-lg font-bold">关于连接断点的提示</h2><p><strong>默认关闭，可在后台配置</strong></p><p>当您开启"连接断点"功能后，图表中的曲线将会跨过那些由于网络问题或其他原因导致的丢包点，形成一条连续的线条。同时，系统会在丢包位置显示<strong>半透明的垂直参考线</strong>来标记断点位置。</p>'}})})]})]}),t.jsxs("div",{className:`flex gap-2 ${A?"w-full mt-2":""}`,children:[t.jsx(H,{variant:"secondary",onClick:V,size:"sm",children:n?.tasks&&p.length===n.tasks.length?t.jsxs(t.Fragment,{children:[t.jsx(fe,{size:16}),"隐藏全部"]}):t.jsxs(t.Fragment,{children:[t.jsx(ke,{size:16}),"显示全部"]})}),t.jsxs(H,{variant:"secondary",onClick:()=>{if(j){if(r.length>1){const e=r.length-1,s=0;h([r[s].time,r[e].time]),y({startIndex:s,endIndex:e}),P(!0)}}else if(r.length>1){const e=r.length-1,s=Math.floor(e*.75);h([r[s].time,r[e].time]),y({startIndex:s,endIndex:e})}},size:"sm",children:[j?t.jsx(ye,{size:16}):t.jsx(xe,{size:16}),j?"重置范围":"四分之一"]})]})]})}),t.jsx(F,{className:"pt-0",children:n?.tasks&&n.tasks.length>0?t.jsx(te,{width:"100%",height:400,children:t.jsxs(se,{data:r,margin:B,children:[t.jsx(ne,{strokeDasharray:"2 4",stroke:"var(--theme-line-muted-color)",vertical:!1}),t.jsx(ae,{type:"number",dataKey:"time",domain:j||["dataMin","dataMax"],tickFormatter:e=>{const s=new Date(e);return d===0?s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}):s.toLocaleString([],{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},tick:{fill:"var(--theme-text-muted-color)"},axisLine:{stroke:"var(--theme-line-muted-color)"},scale:"time"}),t.jsx(ie,{mirror:!0,width:30,tick:{fill:"var(--theme-text-muted-color)"},axisLine:{stroke:"var(--theme-line-muted-color)"}}),t.jsx(re,{cursor:!1,content:t.jsx(oe,{labelFormatter:e=>le(e,d)})}),v&&W.map((e,s)=>t.jsx(ce,{x:e.x,stroke:e.color,strokeWidth:1.5,strokeOpacity:.5},`break-${s}`)),x.map(e=>t.jsx(de,{type:"monotone",dataKey:String(e.id),name:e.name,stroke:S(e.name,x),strokeWidth:2,hide:!p.includes(e.id),dot:!1,connectNulls:v},e.id)),t.jsx(ue,{...z,dataKey:"time",height:30,stroke:"var(--theme-text-muted-color)",fill:"var(--accent-a4)",tickFormatter:e=>{const s=new Date(e);return d===0?s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}):s.toLocaleDateString([],{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},onChange:e=>{e.startIndex!==void 0&&e.endIndex!==void 0&&r[e.startIndex]&&r[e.endIndex]?(h([r[e.startIndex].time,r[e.endIndex].time]),y({startIndex:e.startIndex,endIndex:e.endIndex})):(h(null),y({}))}})]})}):t.jsx("div",{className:"h-[400px] flex items-center justify-center",children:t.jsx("p",{children:"暂无数据"})})})]})]})});export{Te as default};
